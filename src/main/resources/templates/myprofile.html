<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Profile</title>
  <link rel="stylesheet" href="/static/css/reset.css">
  <link rel="stylesheet" href="/static/css/myprofile.css" />
  <link rel="stylesheet" href="/static/css/m-myprofile.css" />
  <script
          src="https://code.jquery.com/jquery-3.6.1.min.js"
          integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
          crossorigin="anonymous"
  ></script>
</head>
<body>
<div class="wrap">
  <div class="logo">
    <img src="" alt="" />
  </div>


    <div class="myProfile">
      <p class="title" id="titleImg">프로필 이미지</p>
      <div class="profileImg" id="pImg">
        <img src="" alt="" class="myImg" id="myImg" name="myImg" />
        <button class="updateBtn" id="updateImg">수정</button>
      </div>


    <div class="update" id="updateName">
      <p class="title">이름</p>
      <input
              type="text"
              th:value="${myProfile.memberName}"
              class="valName"
              name="myName"
              id="inputName"
              disabled
      />
    </div>

    <div class="update" id="updateEmail">
      <p class="title">이메일</p>
      <input
              type="text"
              th:value="${myProfile.memberId}"
              class="valEmail"
              name="myEmail"
              disabled
      />
    </div>

      <div class="update" id="updatePhone">
        <p class="title">휴대전화</p>
        <input
                type="text"
                th:value="${myProfile.memberPhone}"
                class="valPhone"
                name="myPhone"
                id="idPhone"
                disabled
        /><button class="toggle" id="PhoneToggle" type="button" >tog</button>
      </div>
      <div class="hidden" id="hidn2" >
        <p>변경할 휴대전화</p>
        <p class="comment">
          휴대폰 번호는 '-'를 제외하고 입력해주세요.
        </p>
        <input
                type="text"
                value=""
                name="oriPhone"
                id="origin"
                class="inputPhone"
        />
        <button type="submit" style="float: right;">인증번호 발송</button>
        <p>인증번호 입력</p>
        <input
                type="text"
                value=""
                name="newPhone"
                id="new"
                class="inputPhone"
        />
        <button type="submit" style="float: right;">인증번호 확인</button>
        <label for="Timer" id="timerLabel" style="float: left;">남은 시간:</label>
        <input id="Timer" type="text" value="" class="inputPhone" readonly/>
        <button class="updateBtn" id="floatBtn">수정</button>
      </div>

    <div class="update" id="updatePw">
      <p class="title">비밀번호 변경</p>
      <button type="button" class="toggle" id="pwToggle">tog</button>
    </div>
    <div class="hidden" id="hidn3">
      <p>현재 비밀번호</p>
      <input
              type="text"
              value=""
              name="oriPw"
              id="origin"
              class="inputPw"
      />
      <p>변경할 비밀번호</p>
      <input
              type="text"
              value=""
              name="newPw"
              id="new"
              class="inputPw"
      />
      <p>비밀번호 확인</p>
      <input type="text" value="" id="checkPw" class="inputPw" />
      <button class="updateBtn" id="floatBtn">수정</button>
    </div>

</div>

<strong><a href="index.html" id="goBack">뒤로가기</a></strong>
</div>
<script>
  let count =0;
  $(document).ready(function(){
      $("#nameToggle").click(function () {
        if(count==0) {
          $("#hidn1").toggle();
          $("#inputName").attr("disabled", false);
          count=1;
        }else{
          $.ajax({
            url:"/member/ajaxMyName",
            success:function (){
            },error:function (){
            }
          }).done(function (rsp){
            count=0;
            $("#hidn1").toggle();
            $("#inputName").val(rsp);
            $("#inputName").attr("disabled", true);
          })
        }
      })

    $("#pwToggle").click(function() {
      $("#hidn3").toggle();
    })

    $("#PhoneToggle").click(function() {
      $("#hidn2").toggle();
    })

    $("#nameBtn").on("click",function (){
      let updateName = $("#inputName").val();

      $.ajax({
        url:"/member/updateMyName",
        data:{"memberName":updateName},
        success:function (){
        },error:function (){
        }
      }).done(function (){
        count=0;
        $("#hidn1").toggle();
        $("#inputName").val(updateName);
        $("#inputName").attr("disabled", true);
      })
    })
  })

</script>

<script>
  let phoneChkResult = false;
  const Timer = document.getElementById('Timer'); //스코어 기록창-분
  let time= 180000;
  let min=3;
  let sec=60;

  // 문자 인증
  let sendSms = $("#sendSms");
  let inputPhone = $("#inputPhone");
  const phoneRegex = /^010\d{4,4}?\d{4}$/;

  sendSms.on("click",function(){
    let inputPhoneVal = inputPhone.val();
    let phoneResult = phoneRegex.test(inputPhoneVal);

    if(inputPhone.val() == "") {
      alert("휴대폰 번호를 입력하세요"); // 휴대폰 번호 regex해야됨
      phoneChkResult = false;

    }else if(!phoneResult) {
      alert("휴대폰 번호 양식을 확인해주세요.");
      phoneChkResult = false;
      return false;

    }else if(phoneResult){
      sendSms.attr("disabled",false); // 문자 발송 버튼 비활성화(3분간)
      inputPhone.attr("readonly",true);

      // 타이머
      alert("인증번호가 발송되었습니다.");

      sendSms.attr("disabled", true); // 발송 버튼 비활성화

      Timer.value = min + ":" + '00';

      function TIMER() {
        PlAYTIME = setInterval(function () {
          time = time - 1000;
          min = time / (60 * 1000);

          if (sec > 0) {
            sec = sec - 1;
            Timer.value = Math.floor(min) + ':' + sec;

          }
          if (sec === 0) {
            sec = 60;
            Timer.value = Math.floor(min) + ':' + '00'
          }

        }, 1000);
      }
      TIMER();
      setTimeout(function(){
        clearInterval(PlAYTIME);
        sendSms.attr("disabled",false); // 3분이 지나면 버튼 활성화
        phoneChkResult = false;
      },180000);//3분이 되면 타이머를 삭제

      let param = {"to":inputPhoneVal};
      // 문자 발송
      $.ajax({
        url : "/sms/send",
        type : "post",
        contentType: 'application/json',
        data : JSON.stringify(param)
      }).done(function (rsp){
        // 인증번호 확인 버튼 활성화
        let phoneConfirm = $("#phoneConfirm");
        phoneConfirm.removeAttr("disabled");

        // rsp : 문자 번호
        let smsNum = rsp;
        phoneConfirm.on("click",function (){
          if(smsNum == $("#phoneCheckVal").val()){
            alert("인증번호가 일치합니다.");
            phoneChkResult = true;
            $("#phoneCheckVal").attr("readonly",true);
            phoneConfirm.css("display","none");
            $("#timerLabel").css("display","none");
            $("#Timer").css("display","none");
            // 유효성검사 추가하기
          }else{
            alert("인증번호가 일치하지 않습니다. 다시 확인 해주세요.");
            phoneChkResult = false;
          }
        })

      })

    }
  });
</script>
</body>
</html>
